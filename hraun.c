#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>
#include <string.h>
#include <sys/mman.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <unistd.h>
#include <dirent.h>
#include <math.h>


#define TIFF_LITTLE_ENDIAN 0x4949
#define TIFF_BIG_ENDIAN    0x4D4D

typedef struct {
    uint16_t tag;
    uint16_t type;
    uint32_t count;
    uint32_t value_offset;
} TIFFTag;

typedef struct {
    uint16_t byte_order;
    uint16_t version;
    uint32_t ifd_offset;
} TIFFHeader;

typedef struct {
    uint32_t width;
    uint32_t height;
    uint16_t bits_per_sample;
    uint16_t compression;
    uint16_t photometric_interpretation;
    uint16_t samples_per_pixel;
    uint32_t rows_per_strip;
    uint16_t planar_configuration;
    char* image_description;
    char* software;
    uint32_t* strip_offsets;
    uint32_t strip_offsets_count;
} TIFFInfo;

int is_little_endian() {
    uint16_t endian_check = 0x0001;
    return (*(char*)&endian_check == 0x01);
}

uint16_t swap_bytes_16(uint16_t value) {
    return ((value >> 8) & 0x00FF) | ((value << 8) & 0xFF00);
}

uint32_t swap_bytes_32(uint32_t value) {
    return ((value >> 24) & 0x000000FF) |
           ((value >>  8) & 0x0000FF00) |
           ((value <<  8) & 0x00FF0000) |
           ((value << 24) & 0xFF000000);
}

void free_tiff_info(TIFFInfo* info) {
    free(info->image_description);
    free(info->software);
    free(info->strip_offsets);
}

int parse_tiff_header(unsigned char* tiff_data, TIFFInfo* info) {
    TIFFHeader header;
    memcpy(&header, tiff_data, sizeof(TIFFHeader));

    int little_endian = is_little_endian();
    int tiff_little_endian = (header.byte_order == TIFF_LITTLE_ENDIAN);

    if (little_endian != tiff_little_endian) {
        header.version = swap_bytes_16(header.version);
        header.ifd_offset = swap_bytes_32(header.ifd_offset);
    }

    if (header.version != 42) {
        fprintf(stderr, "Unsupported TIFF version: %d\n", header.version);
        return 0;
    }

    uint32_t ifd_offset = header.ifd_offset;
    while (ifd_offset != 0) {
        uint16_t num_entries;
        memcpy(&num_entries, tiff_data + ifd_offset, sizeof(uint16_t));
        if (little_endian != tiff_little_endian) {
            num_entries = swap_bytes_16(num_entries);
        }

        ifd_offset += sizeof(uint16_t);

        for (int i = 0; i < num_entries; i++) {
            TIFFTag tag;
            memcpy(&tag, tiff_data + ifd_offset, sizeof(TIFFTag));
            if (little_endian != tiff_little_endian) {
                tag.tag = swap_bytes_16(tag.tag);
                tag.type = swap_bytes_16(tag.type);
                tag.count = swap_bytes_32(tag.count);
                tag.value_offset = swap_bytes_32(tag.value_offset);
            }

            switch (tag.tag) {
                case 256: // ImageWidth
                    info->width = tag.value_offset;
                    break;
                case 257: // ImageLength
                    info->height = tag.value_offset;
                    break;
                case 258: // BitsPerSample
                    info->bits_per_sample = tag.value_offset;
                    break;
                case 259: // Compression
                    info->compression = tag.value_offset;
                    break;
                case 262: // PhotometricInterpretation
                    info->photometric_interpretation = tag.value_offset;
                    break;
                case 273: // StripOffsets
                    info->strip_offsets_count = tag.count;
                    info->strip_offsets = (uint32_t*)malloc(tag.count * sizeof(uint32_t));
                    if (tag.count == 1) {
                        info->strip_offsets[0] = tag.value_offset;
                    } else {
                        memcpy(info->strip_offsets, tiff_data + tag.value_offset, tag.count * sizeof(uint32_t));
                        if (little_endian != tiff_little_endian) {
                            for (uint32_t j = 0; j < tag.count; j++) {
                                info->strip_offsets[j] = swap_bytes_32(info->strip_offsets[j]);
                            }
                        }
                    }
                    break;
                case 277: // SamplesPerPixel
                    info->samples_per_pixel = tag.value_offset;
                    break;
                case 278: // RowsPerStrip
                    info->rows_per_strip = tag.value_offset;
                    break;
                case 284: // PlanarConfiguration
                    info->planar_configuration = tag.value_offset;
                    break;
                case 270: // ImageDescription
                    info->image_description = (char*)malloc(tag.count * sizeof(char));
                    memcpy(info->image_description, tiff_data + tag.value_offset, tag.count);
                    break;
                case 305: // Software
                    info->software = (char*)malloc(tag.count * sizeof(char));
                    memcpy(info->software, tiff_data + tag.value_offset, tag.count);
                    break;
                default:
                    // Unknown tag, skip it
                    break;
            }

            ifd_offset += sizeof(TIFFTag);
        }

        memcpy(&ifd_offset, tiff_data + ifd_offset, sizeof(uint32_t));
        if (little_endian != tiff_little_endian) {
            ifd_offset = swap_bytes_32(ifd_offset);
        }
    }

    return 1;
}

typedef struct {
    unsigned char** data;
    uint32_t* data_offsets;
    int width;
    int height;
    int depth;
} Volume;

Volume* create_volume(const char* directory) {
    Volume* volume = (Volume*)malloc(sizeof(Volume));
    if (!volume) {
        fprintf(stderr, "Failed to allocate memory for volume\n");
        exit(1);
    }

    DIR* dir = opendir(directory);
    if (!dir) {
        fprintf(stderr, "Failed to open directory: %s\n", directory);
        exit(1);
    }

    struct dirent* entry;
    int num_files = 0;
    while ((entry = readdir(dir)) != NULL) {
        if (entry->d_type == DT_REG && strstr(entry->d_name, ".tif") != NULL) {
            num_files++;
        }
    }

    rewinddir(dir);

    volume->depth = num_files;
    volume->data = (unsigned char**)malloc(num_files * sizeof(unsigned char*));
    volume->data_offsets = (uint32_t*)malloc(num_files * sizeof(uint32_t));
    if (!volume->data || !volume->data_offsets) {
        fprintf(stderr, "Failed to allocate memory for volume data\n");
        exit(1);
    }

    int file_index = 0;
    while ((entry = readdir(dir)) != NULL) {
        if (entry->d_type == DT_REG && strstr(entry->d_name, ".tif") != NULL) {
            char file_path[1024];
            snprintf(file_path, sizeof(file_path), "%s/%s", directory, entry->d_name);
            printf("loading %s\n",file_path);
            if(file_index == 1000)break;
            int fd = open(file_path, O_RDONLY);
            if (fd == -1) {
                fprintf(stderr, "Failed to open TIFF file: %s\n", file_path);
                exit(1);
            }

            struct stat sb;
            if (fstat(fd, &sb) == -1) {
                fprintf(stderr, "Failed to get file size: %s\n", file_path);
                exit(1);
            }

            unsigned char* tiff_data = mmap(NULL, sb.st_size, PROT_READ, MAP_PRIVATE, fd, 0);
            if (tiff_data == MAP_FAILED) {
                fprintf(stderr, "Failed to memory map TIFF file: %s\n", file_path);
                exit(1);
            }

            TIFFInfo info;
            if (parse_tiff_header(tiff_data, &info)) {
                volume->data[file_index] = tiff_data;
                volume->data_offsets[file_index] = info.strip_offsets[0];
                volume->width = info.width;
                volume->height = info.height;
                file_index++;
            } else {
                fprintf(stderr, "Failed to parse TIFF header: %s\n", file_path);
            }

            free_tiff_info(&info);
            close(fd);
        }
    }

    closedir(dir);

    return volume;
}

unsigned char volume_at(Volume* volume, int x, int y, int z) {
    if (x < 0 || x >= volume->width || y < 0 || y >= volume->height || z < 0 || z >= volume->depth) {
        fprintf(stderr, "Invalid coordinates: (%d, %d, %d)\n", x, y, z);
        exit(1);
    }

    unsigned char* tiff_data = volume->data[z];
    uint32_t data_offset = volume->data_offsets[z];
    int index = data_offset + y * volume->width + x;

    return tiff_data[index];
}

unsigned char*** volume_chunk(Volume* volume, int x_offset, int y_offset, int z_offset,
                              int x_size, int y_size, int z_size) {
    if (x_offset < 0 || x_offset + x_size > volume->width ||
        y_offset < 0 || y_offset + y_size > volume->height ||
        z_offset < 0 || z_offset + z_size > volume->depth) {
        fprintf(stderr, "Invalid chunk dimensions\n");
        exit(1);
    }

    unsigned char*** chunk = (unsigned char***)malloc(z_size * sizeof(unsigned char**));
    if (!chunk) {
        fprintf(stderr, "Failed to allocate memory for chunk\n");
        exit(1);
    }

    for (int z = 0; z < z_size; z++) {
        chunk[z] = (unsigned char**)malloc(y_size * sizeof(unsigned char*));
        if (!chunk[z]) {
            fprintf(stderr, "Failed to allocate memory for chunk slice\n");
            exit(1);
        }

        for (int y = 0; y < y_size; y++) {
            chunk[z][y] = (unsigned char*)malloc(x_size * sizeof(unsigned char));
            if (!chunk[z][y]) {
                fprintf(stderr, "Failed to allocate memory for chunk row\n");
                exit(1);
            }

            for (int x = 0; x < x_size; x++) {
                chunk[z][y][x] = volume_at(volume, x_offset + x, y_offset + y, z_offset + z);
            }
        }
    }

    return chunk;
}

void free_volume(Volume* volume) {
    for (int i = 0; i < volume->depth; i++) {
        munmap(volume->data[i], volume->width * volume->height * sizeof(unsigned char));
    }

    free(volume->data);
    free(volume->data_offsets);
    free(volume);
}

void free_chunk(unsigned char*** chunk, int z_size, int y_size) {
    for (int z = 0; z < z_size; z++) {
        for (int y = 0; y < y_size; y++) {
            free(chunk[z][y]);
        }
        free(chunk[z]);
    }
    free(chunk);
}


static const int edgeTable[256]={
        0x0  , 0x109, 0x203, 0x30a, 0x406, 0x50f, 0x605, 0x70c,
        0x80c, 0x905, 0xa0f, 0xb06, 0xc0a, 0xd03, 0xe09, 0xf00,
        0x190, 0x99 , 0x393, 0x29a, 0x596, 0x49f, 0x795, 0x69c,
        0x99c, 0x895, 0xb9f, 0xa96, 0xd9a, 0xc93, 0xf99, 0xe90,
        0x230, 0x339, 0x33 , 0x13a, 0x636, 0x73f, 0x435, 0x53c,
        0xa3c, 0xb35, 0x83f, 0x936, 0xe3a, 0xf33, 0xc39, 0xd30,
        0x3a0, 0x2a9, 0x1a3, 0xaa , 0x7a6, 0x6af, 0x5a5, 0x4ac,
        0xbac, 0xaa5, 0x9af, 0x8a6, 0xfaa, 0xea3, 0xda9, 0xca0,
        0x460, 0x569, 0x663, 0x76a, 0x66 , 0x16f, 0x265, 0x36c,
        0xc6c, 0xd65, 0xe6f, 0xf66, 0x86a, 0x963, 0xa69, 0xb60,
        0x5f0, 0x4f9, 0x7f3, 0x6fa, 0x1f6, 0xff , 0x3f5, 0x2fc,
        0xdfc, 0xcf5, 0xfff, 0xef6, 0x9fa, 0x8f3, 0xbf9, 0xaf0,
        0x650, 0x759, 0x453, 0x55a, 0x256, 0x35f, 0x55 , 0x15c,
        0xe5c, 0xf55, 0xc5f, 0xd56, 0xa5a, 0xb53, 0x859, 0x950,
        0x7c0, 0x6c9, 0x5c3, 0x4ca, 0x3c6, 0x2cf, 0x1c5, 0xcc ,
        0xfcc, 0xec5, 0xdcf, 0xcc6, 0xbca, 0xac3, 0x9c9, 0x8c0,
        0x8c0, 0x9c9, 0xac3, 0xbca, 0xcc6, 0xdcf, 0xec5, 0xfcc,
        0xcc , 0x1c5, 0x2cf, 0x3c6, 0x4ca, 0x5c3, 0x6c9, 0x7c0,
        0x950, 0x859, 0xb53, 0xa5a, 0xd56, 0xc5f, 0xf55, 0xe5c,
        0x15c, 0x55 , 0x35f, 0x256, 0x55a, 0x453, 0x759, 0x650,
        0xaf0, 0xbf9, 0x8f3, 0x9fa, 0xef6, 0xfff, 0xcf5, 0xdfc,
        0x2fc, 0x3f5, 0xff , 0x1f6, 0x6fa, 0x7f3, 0x4f9, 0x5f0,
        0xb60, 0xa69, 0x963, 0x86a, 0xf66, 0xe6f, 0xd65, 0xc6c,
        0x36c, 0x265, 0x16f, 0x66 , 0x76a, 0x663, 0x569, 0x460,
        0xca0, 0xda9, 0xea3, 0xfaa, 0x8a6, 0x9af, 0xaa5, 0xbac,
        0x4ac, 0x5a5, 0x6af, 0x7a6, 0xaa , 0x1a3, 0x2a9, 0x3a0,
        0xd30, 0xc39, 0xf33, 0xe3a, 0x936, 0x83f, 0xb35, 0xa3c,
        0x53c, 0x435, 0x73f, 0x636, 0x13a, 0x33 , 0x339, 0x230,
        0xe90, 0xf99, 0xc93, 0xd9a, 0xa96, 0xb9f, 0x895, 0x99c,
        0x69c, 0x795, 0x49f, 0x596, 0x29a, 0x393, 0x99 , 0x190,
        0xf00, 0xe09, 0xd03, 0xc0a, 0xb06, 0xa0f, 0x905, 0x80c,
        0x70c, 0x605, 0x50f, 0x406, 0x30a, 0x203, 0x109, 0x0   };
static const int triTable[256][16] =
        {{-1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1},
         {0, 8, 3, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1},
         {0, 1, 9, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1},
         {1, 8, 3, 9, 8, 1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1},
         {1, 2, 10, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1},
         {0, 8, 3, 1, 2, 10, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1},
         {9, 2, 10, 0, 2, 9, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1},
         {2, 8, 3, 2, 10, 8, 10, 9, 8, -1, -1, -1, -1, -1, -1, -1},
         {3, 11, 2, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1},
         {0, 11, 2, 8, 11, 0, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1},
         {1, 9, 0, 2, 3, 11, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1},
         {1, 11, 2, 1, 9, 11, 9, 8, 11, -1, -1, -1, -1, -1, -1, -1},
         {3, 10, 1, 11, 10, 3, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1},
         {0, 10, 1, 0, 8, 10, 8, 11, 10, -1, -1, -1, -1, -1, -1, -1},
         {3, 9, 0, 3, 11, 9, 11, 10, 9, -1, -1, -1, -1, -1, -1, -1},
         {9, 8, 10, 10, 8, 11, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1},
         {4, 7, 8, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1},
         {4, 3, 0, 7, 3, 4, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1},
         {0, 1, 9, 8, 4, 7, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1},
         {4, 1, 9, 4, 7, 1, 7, 3, 1, -1, -1, -1, -1, -1, -1, -1},
         {1, 2, 10, 8, 4, 7, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1},
         {3, 4, 7, 3, 0, 4, 1, 2, 10, -1, -1, -1, -1, -1, -1, -1},
         {9, 2, 10, 9, 0, 2, 8, 4, 7, -1, -1, -1, -1, -1, -1, -1},
         {2, 10, 9, 2, 9, 7, 2, 7, 3, 7, 9, 4, -1, -1, -1, -1},
         {8, 4, 7, 3, 11, 2, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1},
         {11, 4, 7, 11, 2, 4, 2, 0, 4, -1, -1, -1, -1, -1, -1, -1},
         {9, 0, 1, 8, 4, 7, 2, 3, 11, -1, -1, -1, -1, -1, -1, -1},
         {4, 7, 11, 9, 4, 11, 9, 11, 2, 9, 2, 1, -1, -1, -1, -1},
         {3, 10, 1, 3, 11, 10, 7, 8, 4, -1, -1, -1, -1, -1, -1, -1},
         {1, 11, 10, 1, 4, 11, 1, 0, 4, 7, 11, 4, -1, -1, -1, -1},
         {4, 7, 8, 9, 0, 11, 9, 11, 10, 11, 0, 3, -1, -1, -1, -1},
         {4, 7, 11, 4, 11, 9, 9, 11, 10, -1, -1, -1, -1, -1, -1, -1},
         {9, 5, 4, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1},
         {9, 5, 4, 0, 8, 3, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1},
         {0, 5, 4, 1, 5, 0, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1},
         {8, 5, 4, 8, 3, 5, 3, 1, 5, -1, -1, -1, -1, -1, -1, -1},
         {1, 2, 10, 9, 5, 4, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1},
         {3, 0, 8, 1, 2, 10, 4, 9, 5, -1, -1, -1, -1, -1, -1, -1},
         {5, 2, 10, 5, 4, 2, 4, 0, 2, -1, -1, -1, -1, -1, -1, -1},
         {2, 10, 5, 3, 2, 5, 3, 5, 4, 3, 4, 8, -1, -1, -1, -1},
         {9, 5, 4, 2, 3, 11, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1},
         {0, 11, 2, 0, 8, 11, 4, 9, 5, -1, -1, -1, -1, -1, -1, -1},
         {0, 5, 4, 0, 1, 5, 2, 3, 11, -1, -1, -1, -1, -1, -1, -1},
         {2, 1, 5, 2, 5, 8, 2, 8, 11, 4, 8, 5, -1, -1, -1, -1},
         {10, 3, 11, 10, 1, 3, 9, 5, 4, -1, -1, -1, -1, -1, -1, -1},
         {4, 9, 5, 0, 8, 1, 8, 10, 1, 8, 11, 10, -1, -1, -1, -1},
         {5, 4, 0, 5, 0, 11, 5, 11, 10, 11, 0, 3, -1, -1, -1, -1},
         {5, 4, 8, 5, 8, 10, 10, 8, 11, -1, -1, -1, -1, -1, -1, -1},
         {9, 7, 8, 5, 7, 9, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1},
         {9, 3, 0, 9, 5, 3, 5, 7, 3, -1, -1, -1, -1, -1, -1, -1},
         {0, 7, 8, 0, 1, 7, 1, 5, 7, -1, -1, -1, -1, -1, -1, -1},
         {1, 5, 3, 3, 5, 7, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1},
         {9, 7, 8, 9, 5, 7, 10, 1, 2, -1, -1, -1, -1, -1, -1, -1},
         {10, 1, 2, 9, 5, 0, 5, 3, 0, 5, 7, 3, -1, -1, -1, -1},
         {8, 0, 2, 8, 2, 5, 8, 5, 7, 10, 5, 2, -1, -1, -1, -1},
         {2, 10, 5, 2, 5, 3, 3, 5, 7, -1, -1, -1, -1, -1, -1, -1},
         {7, 9, 5, 7, 8, 9, 3, 11, 2, -1, -1, -1, -1, -1, -1, -1},
         {9, 5, 7, 9, 7, 2, 9, 2, 0, 2, 7, 11, -1, -1, -1, -1},
         {2, 3, 11, 0, 1, 8, 1, 7, 8, 1, 5, 7, -1, -1, -1, -1},
         {11, 2, 1, 11, 1, 7, 7, 1, 5, -1, -1, -1, -1, -1, -1, -1},
         {9, 5, 8, 8, 5, 7, 10, 1, 3, 10, 3, 11, -1, -1, -1, -1},
         {5, 7, 0, 5, 0, 9, 7, 11, 0, 1, 0, 10, 11, 10, 0, -1},
         {11, 10, 0, 11, 0, 3, 10, 5, 0, 8, 0, 7, 5, 7, 0, -1},
         {11, 10, 5, 7, 11, 5, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1},
         {10, 6, 5, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1},
         {0, 8, 3, 5, 10, 6, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1},
         {9, 0, 1, 5, 10, 6, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1},
         {1, 8, 3, 1, 9, 8, 5, 10, 6, -1, -1, -1, -1, -1, -1, -1},
         {1, 6, 5, 2, 6, 1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1},
         {1, 6, 5, 1, 2, 6, 3, 0, 8, -1, -1, -1, -1, -1, -1, -1},
         {9, 6, 5, 9, 0, 6, 0, 2, 6, -1, -1, -1, -1, -1, -1, -1},
         {5, 9, 8, 5, 8, 2, 5, 2, 6, 3, 2, 8, -1, -1, -1, -1},
         {2, 3, 11, 10, 6, 5, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1},
         {11, 0, 8, 11, 2, 0, 10, 6, 5, -1, -1, -1, -1, -1, -1, -1},
         {0, 1, 9, 2, 3, 11, 5, 10, 6, -1, -1, -1, -1, -1, -1, -1},
         {5, 10, 6, 1, 9, 2, 9, 11, 2, 9, 8, 11, -1, -1, -1, -1},
         {6, 3, 11, 6, 5, 3, 5, 1, 3, -1, -1, -1, -1, -1, -1, -1},
         {0, 8, 11, 0, 11, 5, 0, 5, 1, 5, 11, 6, -1, -1, -1, -1},
         {3, 11, 6, 0, 3, 6, 0, 6, 5, 0, 5, 9, -1, -1, -1, -1},
         {6, 5, 9, 6, 9, 11, 11, 9, 8, -1, -1, -1, -1, -1, -1, -1},
         {5, 10, 6, 4, 7, 8, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1},
         {4, 3, 0, 4, 7, 3, 6, 5, 10, -1, -1, -1, -1, -1, -1, -1},
         {1, 9, 0, 5, 10, 6, 8, 4, 7, -1, -1, -1, -1, -1, -1, -1},
         {10, 6, 5, 1, 9, 7, 1, 7, 3, 7, 9, 4, -1, -1, -1, -1},
         {6, 1, 2, 6, 5, 1, 4, 7, 8, -1, -1, -1, -1, -1, -1, -1},
         {1, 2, 5, 5, 2, 6, 3, 0, 4, 3, 4, 7, -1, -1, -1, -1},
         {8, 4, 7, 9, 0, 5, 0, 6, 5, 0, 2, 6, -1, -1, -1, -1},
         {7, 3, 9, 7, 9, 4, 3, 2, 9, 5, 9, 6, 2, 6, 9, -1},
         {3, 11, 2, 7, 8, 4, 10, 6, 5, -1, -1, -1, -1, -1, -1, -1},
         {5, 10, 6, 4, 7, 2, 4, 2, 0, 2, 7, 11, -1, -1, -1, -1},
         {0, 1, 9, 4, 7, 8, 2, 3, 11, 5, 10, 6, -1, -1, -1, -1},
         {9, 2, 1, 9, 11, 2, 9, 4, 11, 7, 11, 4, 5, 10, 6, -1},
         {8, 4, 7, 3, 11, 5, 3, 5, 1, 5, 11, 6, -1, -1, -1, -1},
         {5, 1, 11, 5, 11, 6, 1, 0, 11, 7, 11, 4, 0, 4, 11, -1},
         {0, 5, 9, 0, 6, 5, 0, 3, 6, 11, 6, 3, 8, 4, 7, -1},
         {6, 5, 9, 6, 9, 11, 4, 7, 9, 7, 11, 9, -1, -1, -1, -1},
         {10, 4, 9, 6, 4, 10, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1},
         {4, 10, 6, 4, 9, 10, 0, 8, 3, -1, -1, -1, -1, -1, -1, -1},
         {10, 0, 1, 10, 6, 0, 6, 4, 0, -1, -1, -1, -1, -1, -1, -1},
         {8, 3, 1, 8, 1, 6, 8, 6, 4, 6, 1, 10, -1, -1, -1, -1},
         {1, 4, 9, 1, 2, 4, 2, 6, 4, -1, -1, -1, -1, -1, -1, -1},
         {3, 0, 8, 1, 2, 9, 2, 4, 9, 2, 6, 4, -1, -1, -1, -1},
         {0, 2, 4, 4, 2, 6, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1},
         {8, 3, 2, 8, 2, 4, 4, 2, 6, -1, -1, -1, -1, -1, -1, -1},
         {10, 4, 9, 10, 6, 4, 11, 2, 3, -1, -1, -1, -1, -1, -1, -1},
         {0, 8, 2, 2, 8, 11, 4, 9, 10, 4, 10, 6, -1, -1, -1, -1},
         {3, 11, 2, 0, 1, 6, 0, 6, 4, 6, 1, 10, -1, -1, -1, -1},
         {6, 4, 1, 6, 1, 10, 4, 8, 1, 2, 1, 11, 8, 11, 1, -1},
         {9, 6, 4, 9, 3, 6, 9, 1, 3, 11, 6, 3, -1, -1, -1, -1},
         {8, 11, 1, 8, 1, 0, 11, 6, 1, 9, 1, 4, 6, 4, 1, -1},
         {3, 11, 6, 3, 6, 0, 0, 6, 4, -1, -1, -1, -1, -1, -1, -1},
         {6, 4, 8, 11, 6, 8, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1},
         {7, 10, 6, 7, 8, 10, 8, 9, 10, -1, -1, -1, -1, -1, -1, -1},
         {0, 7, 3, 0, 10, 7, 0, 9, 10, 6, 7, 10, -1, -1, -1, -1},
         {10, 6, 7, 1, 10, 7, 1, 7, 8, 1, 8, 0, -1, -1, -1, -1},
         {10, 6, 7, 10, 7, 1, 1, 7, 3, -1, -1, -1, -1, -1, -1, -1},
         {1, 2, 6, 1, 6, 8, 1, 8, 9, 8, 6, 7, -1, -1, -1, -1},
         {2, 6, 9, 2, 9, 1, 6, 7, 9, 0, 9, 3, 7, 3, 9, -1},
         {7, 8, 0, 7, 0, 6, 6, 0, 2, -1, -1, -1, -1, -1, -1, -1},
         {7, 3, 2, 6, 7, 2, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1},
         {2, 3, 11, 10, 6, 8, 10, 8, 9, 8, 6, 7, -1, -1, -1, -1},
         {2, 0, 7, 2, 7, 11, 0, 9, 7, 6, 7, 10, 9, 10, 7, -1},
         {1, 8, 0, 1, 7, 8, 1, 10, 7, 6, 7, 10, 2, 3, 11, -1},
         {11, 2, 1, 11, 1, 7, 10, 6, 1, 6, 7, 1, -1, -1, -1, -1},
         {8, 9, 6, 8, 6, 7, 9, 1, 6, 11, 6, 3, 1, 3, 6, -1},
         {0, 9, 1, 11, 6, 7, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1},
         {7, 8, 0, 7, 0, 6, 3, 11, 0, 11, 6, 0, -1, -1, -1, -1},
         {7, 11, 6, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1},
         {7, 6, 11, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1},
         {3, 0, 8, 11, 7, 6, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1},
         {0, 1, 9, 11, 7, 6, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1},
         {8, 1, 9, 8, 3, 1, 11, 7, 6, -1, -1, -1, -1, -1, -1, -1},
         {10, 1, 2, 6, 11, 7, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1},
         {1, 2, 10, 3, 0, 8, 6, 11, 7, -1, -1, -1, -1, -1, -1, -1},
         {2, 9, 0, 2, 10, 9, 6, 11, 7, -1, -1, -1, -1, -1, -1, -1},
         {6, 11, 7, 2, 10, 3, 10, 8, 3, 10, 9, 8, -1, -1, -1, -1},
         {7, 2, 3, 6, 2, 7, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1},
         {7, 0, 8, 7, 6, 0, 6, 2, 0, -1, -1, -1, -1, -1, -1, -1},
         {2, 7, 6, 2, 3, 7, 0, 1, 9, -1, -1, -1, -1, -1, -1, -1},
         {1, 6, 2, 1, 8, 6, 1, 9, 8, 8, 7, 6, -1, -1, -1, -1},
         {10, 7, 6, 10, 1, 7, 1, 3, 7, -1, -1, -1, -1, -1, -1, -1},
         {10, 7, 6, 1, 7, 10, 1, 8, 7, 1, 0, 8, -1, -1, -1, -1},
         {0, 3, 7, 0, 7, 10, 0, 10, 9, 6, 10, 7, -1, -1, -1, -1},
         {7, 6, 10, 7, 10, 8, 8, 10, 9, -1, -1, -1, -1, -1, -1, -1},
         {6, 8, 4, 11, 8, 6, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1},
         {3, 6, 11, 3, 0, 6, 0, 4, 6, -1, -1, -1, -1, -1, -1, -1},
         {8, 6, 11, 8, 4, 6, 9, 0, 1, -1, -1, -1, -1, -1, -1, -1},
         {9, 4, 6, 9, 6, 3, 9, 3, 1, 11, 3, 6, -1, -1, -1, -1},
         {6, 8, 4, 6, 11, 8, 2, 10, 1, -1, -1, -1, -1, -1, -1, -1},
         {1, 2, 10, 3, 0, 11, 0, 6, 11, 0, 4, 6, -1, -1, -1, -1},
         {4, 11, 8, 4, 6, 11, 0, 2, 9, 2, 10, 9, -1, -1, -1, -1},
         {10, 9, 3, 10, 3, 2, 9, 4, 3, 11, 3, 6, 4, 6, 3, -1},
         {8, 2, 3, 8, 4, 2, 4, 6, 2, -1, -1, -1, -1, -1, -1, -1},
         {0, 4, 2, 4, 6, 2, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1},
         {1, 9, 0, 2, 3, 4, 2, 4, 6, 4, 3, 8, -1, -1, -1, -1},
         {1, 9, 4, 1, 4, 2, 2, 4, 6, -1, -1, -1, -1, -1, -1, -1},
         {8, 1, 3, 8, 6, 1, 8, 4, 6, 6, 10, 1, -1, -1, -1, -1},
         {10, 1, 0, 10, 0, 6, 6, 0, 4, -1, -1, -1, -1, -1, -1, -1},
         {4, 6, 3, 4, 3, 8, 6, 10, 3, 0, 3, 9, 10, 9, 3, -1},
         {10, 9, 4, 6, 10, 4, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1},
         {4, 9, 5, 7, 6, 11, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1},
         {0, 8, 3, 4, 9, 5, 11, 7, 6, -1, -1, -1, -1, -1, -1, -1},
         {5, 0, 1, 5, 4, 0, 7, 6, 11, -1, -1, -1, -1, -1, -1, -1},
         {11, 7, 6, 8, 3, 4, 3, 5, 4, 3, 1, 5, -1, -1, -1, -1},
         {9, 5, 4, 10, 1, 2, 7, 6, 11, -1, -1, -1, -1, -1, -1, -1},
         {6, 11, 7, 1, 2, 10, 0, 8, 3, 4, 9, 5, -1, -1, -1, -1},
         {7, 6, 11, 5, 4, 10, 4, 2, 10, 4, 0, 2, -1, -1, -1, -1},
         {3, 4, 8, 3, 5, 4, 3, 2, 5, 10, 5, 2, 11, 7, 6, -1},
         {7, 2, 3, 7, 6, 2, 5, 4, 9, -1, -1, -1, -1, -1, -1, -1},
         {9, 5, 4, 0, 8, 6, 0, 6, 2, 6, 8, 7, -1, -1, -1, -1},
         {3, 6, 2, 3, 7, 6, 1, 5, 0, 5, 4, 0, -1, -1, -1, -1},
         {6, 2, 8, 6, 8, 7, 2, 1, 8, 4, 8, 5, 1, 5, 8, -1},
         {9, 5, 4, 10, 1, 6, 1, 7, 6, 1, 3, 7, -1, -1, -1, -1},
         {1, 6, 10, 1, 7, 6, 1, 0, 7, 8, 7, 0, 9, 5, 4, -1},
         {4, 0, 10, 4, 10, 5, 0, 3, 10, 6, 10, 7, 3, 7, 10, -1},
         {7, 6, 10, 7, 10, 8, 5, 4, 10, 4, 8, 10, -1, -1, -1, -1},
         {6, 9, 5, 6, 11, 9, 11, 8, 9, -1, -1, -1, -1, -1, -1, -1},
         {3, 6, 11, 0, 6, 3, 0, 5, 6, 0, 9, 5, -1, -1, -1, -1},
         {0, 11, 8, 0, 5, 11, 0, 1, 5, 5, 6, 11, -1, -1, -1, -1},
         {6, 11, 3, 6, 3, 5, 5, 3, 1, -1, -1, -1, -1, -1, -1, -1},
         {1, 2, 10, 9, 5, 11, 9, 11, 8, 11, 5, 6, -1, -1, -1, -1},
         {0, 11, 3, 0, 6, 11, 0, 9, 6, 5, 6, 9, 1, 2, 10, -1},
         {11, 8, 5, 11, 5, 6, 8, 0, 5, 10, 5, 2, 0, 2, 5, -1},
         {6, 11, 3, 6, 3, 5, 2, 10, 3, 10, 5, 3, -1, -1, -1, -1},
         {5, 8, 9, 5, 2, 8, 5, 6, 2, 3, 8, 2, -1, -1, -1, -1},
         {9, 5, 6, 9, 6, 0, 0, 6, 2, -1, -1, -1, -1, -1, -1, -1},
         {1, 5, 8, 1, 8, 0, 5, 6, 8, 3, 8, 2, 6, 2, 8, -1},
         {1, 5, 6, 2, 1, 6, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1},
         {1, 3, 6, 1, 6, 10, 3, 8, 6, 5, 6, 9, 8, 9, 6, -1},
         {10, 1, 0, 10, 0, 6, 9, 5, 0, 5, 6, 0, -1, -1, -1, -1},
         {0, 3, 8, 5, 6, 10, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1},
         {10, 5, 6, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1},
         {11, 5, 10, 7, 5, 11, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1},
         {11, 5, 10, 11, 7, 5, 8, 3, 0, -1, -1, -1, -1, -1, -1, -1},
         {5, 11, 7, 5, 10, 11, 1, 9, 0, -1, -1, -1, -1, -1, -1, -1},
         {10, 7, 5, 10, 11, 7, 9, 8, 1, 8, 3, 1, -1, -1, -1, -1},
         {11, 1, 2, 11, 7, 1, 7, 5, 1, -1, -1, -1, -1, -1, -1, -1},
         {0, 8, 3, 1, 2, 7, 1, 7, 5, 7, 2, 11, -1, -1, -1, -1},
         {9, 7, 5, 9, 2, 7, 9, 0, 2, 2, 11, 7, -1, -1, -1, -1},
         {7, 5, 2, 7, 2, 11, 5, 9, 2, 3, 2, 8, 9, 8, 2, -1},
         {2, 5, 10, 2, 3, 5, 3, 7, 5, -1, -1, -1, -1, -1, -1, -1},
         {8, 2, 0, 8, 5, 2, 8, 7, 5, 10, 2, 5, -1, -1, -1, -1},
         {9, 0, 1, 5, 10, 3, 5, 3, 7, 3, 10, 2, -1, -1, -1, -1},
         {9, 8, 2, 9, 2, 1, 8, 7, 2, 10, 2, 5, 7, 5, 2, -1},
         {1, 3, 5, 3, 7, 5, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1},
         {0, 8, 7, 0, 7, 1, 1, 7, 5, -1, -1, -1, -1, -1, -1, -1},
         {9, 0, 3, 9, 3, 5, 5, 3, 7, -1, -1, -1, -1, -1, -1, -1},
         {9, 8, 7, 5, 9, 7, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1},
         {5, 8, 4, 5, 10, 8, 10, 11, 8, -1, -1, -1, -1, -1, -1, -1},
         {5, 0, 4, 5, 11, 0, 5, 10, 11, 11, 3, 0, -1, -1, -1, -1},
         {0, 1, 9, 8, 4, 10, 8, 10, 11, 10, 4, 5, -1, -1, -1, -1},
         {10, 11, 4, 10, 4, 5, 11, 3, 4, 9, 4, 1, 3, 1, 4, -1},
         {2, 5, 1, 2, 8, 5, 2, 11, 8, 4, 5, 8, -1, -1, -1, -1},
         {0, 4, 11, 0, 11, 3, 4, 5, 11, 2, 11, 1, 5, 1, 11, -1},
         {0, 2, 5, 0, 5, 9, 2, 11, 5, 4, 5, 8, 11, 8, 5, -1},
         {9, 4, 5, 2, 11, 3, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1},
         {2, 5, 10, 3, 5, 2, 3, 4, 5, 3, 8, 4, -1, -1, -1, -1},
         {5, 10, 2, 5, 2, 4, 4, 2, 0, -1, -1, -1, -1, -1, -1, -1},
         {3, 10, 2, 3, 5, 10, 3, 8, 5, 4, 5, 8, 0, 1, 9, -1},
         {5, 10, 2, 5, 2, 4, 1, 9, 2, 9, 4, 2, -1, -1, -1, -1},
         {8, 4, 5, 8, 5, 3, 3, 5, 1, -1, -1, -1, -1, -1, -1, -1},
         {0, 4, 5, 1, 0, 5, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1},
         {8, 4, 5, 8, 5, 3, 9, 0, 5, 0, 3, 5, -1, -1, -1, -1},
         {9, 4, 5, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1},
         {4, 11, 7, 4, 9, 11, 9, 10, 11, -1, -1, -1, -1, -1, -1, -1},
         {0, 8, 3, 4, 9, 7, 9, 11, 7, 9, 10, 11, -1, -1, -1, -1},
         {1, 10, 11, 1, 11, 4, 1, 4, 0, 7, 4, 11, -1, -1, -1, -1},
         {3, 1, 4, 3, 4, 8, 1, 10, 4, 7, 4, 11, 10, 11, 4, -1},
         {4, 11, 7, 9, 11, 4, 9, 2, 11, 9, 1, 2, -1, -1, -1, -1},
         {9, 7, 4, 9, 11, 7, 9, 1, 11, 2, 11, 1, 0, 8, 3, -1},
         {11, 7, 4, 11, 4, 2, 2, 4, 0, -1, -1, -1, -1, -1, -1, -1},
         {11, 7, 4, 11, 4, 2, 8, 3, 4, 3, 2, 4, -1, -1, -1, -1},
         {2, 9, 10, 2, 7, 9, 2, 3, 7, 7, 4, 9, -1, -1, -1, -1},
         {9, 10, 7, 9, 7, 4, 10, 2, 7, 8, 7, 0, 2, 0, 7, -1},
         {3, 7, 10, 3, 10, 2, 7, 4, 10, 1, 10, 0, 4, 0, 10, -1},
         {1, 10, 2, 8, 7, 4, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1},
         {4, 9, 1, 4, 1, 7, 7, 1, 3, -1, -1, -1, -1, -1, -1, -1},
         {4, 9, 1, 4, 1, 7, 0, 8, 1, 8, 7, 1, -1, -1, -1, -1},
         {4, 0, 3, 7, 4, 3, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1},
         {4, 8, 7, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1},
         {9, 10, 8, 10, 11, 8, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1},
         {3, 0, 9, 3, 9, 11, 11, 9, 10, -1, -1, -1, -1, -1, -1, -1},
         {0, 1, 10, 0, 10, 8, 8, 10, 11, -1, -1, -1, -1, -1, -1, -1},
         {3, 1, 10, 11, 3, 10, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1},
         {1, 2, 11, 1, 11, 9, 9, 11, 8, -1, -1, -1, -1, -1, -1, -1},
         {3, 0, 9, 3, 9, 11, 1, 2, 9, 2, 11, 9, -1, -1, -1, -1},
         {0, 2, 11, 8, 0, 11, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1},
         {3, 2, 11, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1},
         {2, 3, 8, 2, 8, 10, 10, 8, 9, -1, -1, -1, -1, -1, -1, -1},
         {9, 10, 2, 0, 9, 2, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1},
         {2, 3, 8, 2, 8, 10, 0, 1, 8, 1, 10, 8, -1, -1, -1, -1},
         {1, 10, 2, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1},
         {1, 3, 8, 9, 1, 8, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1},
         {0, 9, 1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1},
         {0, 3, 8, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1},
         {-1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1}};

static float viridis_colors[256][3] = {
        {0.26700400f, 0.00487400f, 0.32941500f},
        {0.26851000f, 0.00960500f, 0.33542700f},
        {0.26994400f, 0.01462500f, 0.34137900f},
        {0.27130500f, 0.01994200f, 0.34726900f},
        {0.27259400f, 0.02556300f, 0.35309300f},
        {0.27380900f, 0.03149700f, 0.35885300f},
        {0.27495200f, 0.03775200f, 0.36454300f},
        {0.27602200f, 0.04416700f, 0.37016400f},
        {0.27701800f, 0.05034400f, 0.37571500f},
        {0.27794100f, 0.05632400f, 0.38119100f},
        {0.27879100f, 0.06214500f, 0.38659200f},
        {0.27956600f, 0.06783600f, 0.39191700f},
        {0.28026700f, 0.07341700f, 0.39716300f},
        {0.28089400f, 0.07890700f, 0.40232900f},
        {0.28144600f, 0.08432000f, 0.40741400f},
        {0.28192400f, 0.08966600f, 0.41241500f},
        {0.28232700f, 0.09495500f, 0.41733100f},
        {0.28265600f, 0.10019600f, 0.42216000f},
        {0.28291000f, 0.10539300f, 0.42690200f},
        {0.28309100f, 0.11055300f, 0.43155400f},
        {0.28319700f, 0.11568000f, 0.43611500f},
        {0.28322900f, 0.12077700f, 0.44058400f},
        {0.28318700f, 0.12584800f, 0.44496000f},
        {0.28307200f, 0.13089500f, 0.44924100f},
        {0.28288400f, 0.13592000f, 0.45342700f},
        {0.28262300f, 0.14092600f, 0.45751700f},
        {0.28229000f, 0.14591200f, 0.46151000f},
        {0.28188700f, 0.15088100f, 0.46540500f},
        {0.28141200f, 0.15583400f, 0.46920100f},
        {0.28086800f, 0.16077100f, 0.47289900f},
        {0.28025500f, 0.16569300f, 0.47649800f},
        {0.27957400f, 0.17059900f, 0.47999700f},
        {0.27882600f, 0.17549000f, 0.48339700f},
        {0.27801200f, 0.18036700f, 0.48669700f},
        {0.27713400f, 0.18522800f, 0.48989800f},
        {0.27619400f, 0.19007400f, 0.49300100f},
        {0.27519100f, 0.19490500f, 0.49600500f},
        {0.27412800f, 0.19972100f, 0.49891100f},
        {0.27300600f, 0.20452000f, 0.50172100f},
        {0.27182800f, 0.20930300f, 0.50443400f},
        {0.27059500f, 0.21406900f, 0.50705200f},
        {0.26930800f, 0.21881800f, 0.50957700f},
        {0.26796800f, 0.22354900f, 0.51200800f},
        {0.26658000f, 0.22826200f, 0.51434900f},
        {0.26514500f, 0.23295600f, 0.51659900f},
        {0.26366300f, 0.23763100f, 0.51876200f},
        {0.26213800f, 0.24228600f, 0.52083700f},
        {0.26057100f, 0.24692200f, 0.52282800f},
        {0.25896500f, 0.25153700f, 0.52473600f},
        {0.25732200f, 0.25613000f, 0.52656300f},
        {0.25564500f, 0.26070300f, 0.52831200f},
        {0.25393500f, 0.26525400f, 0.52998300f},
        {0.25219400f, 0.26978300f, 0.53157900f},
        {0.25042500f, 0.27429000f, 0.53310300f},
        {0.24862900f, 0.27877500f, 0.53455600f},
        {0.24681100f, 0.28323700f, 0.53594100f},
        {0.24497200f, 0.28767500f, 0.53726000f},
        {0.24311300f, 0.29209200f, 0.53851600f},
        {0.24123700f, 0.29648500f, 0.53970900f},
        {0.23934600f, 0.30085500f, 0.54084400f},
        {0.23744100f, 0.30520200f, 0.54192100f},
        {0.23552600f, 0.30952700f, 0.54294400f},
        {0.23360300f, 0.31382800f, 0.54391400f},
        {0.23167400f, 0.31810600f, 0.54483400f},
        {0.22973900f, 0.32236100f, 0.54570600f},
        {0.22780200f, 0.32659400f, 0.54653200f},
        {0.22586300f, 0.33080500f, 0.54731400f},
        {0.22392500f, 0.33499400f, 0.54805300f},
        {0.22198900f, 0.33916100f, 0.54875200f},
        {0.22005700f, 0.34330700f, 0.54941300f},
        {0.21813000f, 0.34743200f, 0.55003800f},
        {0.21621000f, 0.35153500f, 0.55062700f},
        {0.21429800f, 0.35561900f, 0.55118400f},
        {0.21239500f, 0.35968300f, 0.55171000f},
        {0.21050300f, 0.36372700f, 0.55220600f},
        {0.20862300f, 0.36775200f, 0.55267500f},
        {0.20675600f, 0.37175800f, 0.55311700f},
        {0.20490300f, 0.37574600f, 0.55353300f},
        {0.20306300f, 0.37971600f, 0.55392500f},
        {0.20123900f, 0.38367000f, 0.55429400f},
        {0.19943000f, 0.38760700f, 0.55464200f},
        {0.19763600f, 0.39152800f, 0.55496900f},
        {0.19586000f, 0.39543300f, 0.55527600f},
        {0.19410000f, 0.39932300f, 0.55556500f},
        {0.19235700f, 0.40319900f, 0.55583600f},
        {0.19063100f, 0.40706100f, 0.55608900f},
        {0.18892300f, 0.41091000f, 0.55632600f},
        {0.18723100f, 0.41474600f, 0.55654700f},
        {0.18555600f, 0.41857000f, 0.55675300f},
        {0.18389800f, 0.42238300f, 0.55694400f},
        {0.18225600f, 0.42618400f, 0.55712000f},
        {0.18062900f, 0.42997500f, 0.55728200f},
        {0.17901900f, 0.43375600f, 0.55743000f},
        {0.17742300f, 0.43752700f, 0.55756500f},
        {0.17584100f, 0.44129000f, 0.55768500f},
        {0.17427400f, 0.44504400f, 0.55779200f},
        {0.17271900f, 0.44879100f, 0.55788500f},
        {0.17117600f, 0.45253000f, 0.55796500f},
        {0.16964600f, 0.45626200f, 0.55803000f},
        {0.16812600f, 0.45998800f, 0.55808200f},
        {0.16661700f, 0.46370800f, 0.55811900f},
        {0.16511700f, 0.46742300f, 0.55814100f},
        {0.16362500f, 0.47113300f, 0.55814800f},
        {0.16214200f, 0.47483800f, 0.55814000f},
        {0.16066500f, 0.47854000f, 0.55811500f},
        {0.15919400f, 0.48223700f, 0.55807300f},
        {0.15772900f, 0.48593200f, 0.55801300f},
        {0.15627000f, 0.48962400f, 0.55793600f},
        {0.15481500f, 0.49331300f, 0.55784000f},
        {0.15336400f, 0.49700000f, 0.55772400f},
        {0.15191800f, 0.50068500f, 0.55758700f},
        {0.15047600f, 0.50436900f, 0.55743000f},
        {0.14903900f, 0.50805100f, 0.55725000f},
        {0.14760700f, 0.51173300f, 0.55704900f},
        {0.14618000f, 0.51541300f, 0.55682300f},
        {0.14475900f, 0.51909300f, 0.55657200f},
        {0.14334300f, 0.52277300f, 0.55629500f},
        {0.14193500f, 0.52645300f, 0.55599100f},
        {0.14053600f, 0.53013200f, 0.55565900f},
        {0.13914700f, 0.53381200f, 0.55529800f},
        {0.13777000f, 0.53749200f, 0.55490600f},
        {0.13640800f, 0.54117300f, 0.55448300f},
        {0.13506600f, 0.54485300f, 0.55402900f},
        {0.13374300f, 0.54853500f, 0.55354100f},
        {0.13244400f, 0.55221600f, 0.55301800f},
        {0.13117200f, 0.55589900f, 0.55245900f},
        {0.12993300f, 0.55958200f, 0.55186400f},
        {0.12872900f, 0.56326500f, 0.55122900f},
        {0.12756800f, 0.56694900f, 0.55055600f},
        {0.12645300f, 0.57063300f, 0.54984100f},
        {0.12539400f, 0.57431800f, 0.54908600f},
        {0.12439500f, 0.57800200f, 0.54828700f},
        {0.12346300f, 0.58168700f, 0.54744500f},
        {0.12260600f, 0.58537100f, 0.54655700f},
        {0.12183100f, 0.58905500f, 0.54562300f},
        {0.12114800f, 0.59273900f, 0.54464100f},
        {0.12056500f, 0.59642200f, 0.54361100f},
        {0.12009200f, 0.60010400f, 0.54253000f},
        {0.11973800f, 0.60378500f, 0.54140000f},
        {0.11951200f, 0.60746400f, 0.54021800f},
        {0.11942300f, 0.61114100f, 0.53898200f},
        {0.11948300f, 0.61481700f, 0.53769200f},
        {0.11969900f, 0.61849000f, 0.53634700f},
        {0.12008100f, 0.62216100f, 0.53494600f},
        {0.12063800f, 0.62582800f, 0.53348800f},
        {0.12138000f, 0.62949200f, 0.53197300f},
        {0.12231200f, 0.63315300f, 0.53039800f},
        {0.12344400f, 0.63680900f, 0.52876300f},
        {0.12478000f, 0.64046100f, 0.52706800f},
        {0.12632600f, 0.64410700f, 0.52531100f},
        {0.12808700f, 0.64774900f, 0.52349100f},
        {0.13006700f, 0.65138400f, 0.52160800f},
        {0.13226800f, 0.65501400f, 0.51966100f},
        {0.13469200f, 0.65863600f, 0.51764900f},
        {0.13733900f, 0.66225200f, 0.51557100f},
        {0.14021000f, 0.66585900f, 0.51342700f},
        {0.14330300f, 0.66945900f, 0.51121500f},
        {0.14661600f, 0.67305000f, 0.50893600f},
        {0.15014800f, 0.67663100f, 0.50658900f},
        {0.15389400f, 0.68020300f, 0.50417200f},
        {0.15785100f, 0.68376500f, 0.50168600f},
        {0.16201600f, 0.68731600f, 0.49912900f},
        {0.16638300f, 0.69085600f, 0.49650200f},
        {0.17094800f, 0.69438400f, 0.49380300f},
        {0.17570700f, 0.69790000f, 0.49103300f},
        {0.18065300f, 0.70140200f, 0.48818900f},
        {0.18578300f, 0.70489100f, 0.48527300f},
        {0.19109000f, 0.70836600f, 0.48228400f},
        {0.19657100f, 0.71182700f, 0.47922100f},
        {0.20221900f, 0.71527200f, 0.47608400f},
        {0.20803000f, 0.71870100f, 0.47287300f},
        {0.21400000f, 0.72211400f, 0.46958800f},
        {0.22012400f, 0.72550900f, 0.46622600f},
        {0.22639700f, 0.72888800f, 0.46278900f},
        {0.23281500f, 0.73224700f, 0.45927700f},
        {0.23937400f, 0.73558800f, 0.45568800f},
        {0.24607000f, 0.73891000f, 0.45202400f},
        {0.25289900f, 0.74221100f, 0.44828400f},
        {0.25985700f, 0.74549200f, 0.44446700f},
        {0.26694100f, 0.74875100f, 0.44057300f},
        {0.27414900f, 0.75198800f, 0.43660100f},
        {0.28147700f, 0.75520300f, 0.43255200f},
        {0.28892100f, 0.75839400f, 0.42842600f},
        {0.29647900f, 0.76156100f, 0.42422300f},
        {0.30414800f, 0.76470400f, 0.41994300f},
        {0.31192500f, 0.76782200f, 0.41558600f},
        {0.31980900f, 0.77091400f, 0.41115200f},
        {0.32779600f, 0.77398000f, 0.40664000f},
        {0.33588500f, 0.77701800f, 0.40204900f},
        {0.34407400f, 0.78002900f, 0.39738100f},
        {0.35236000f, 0.78301100f, 0.39263600f},
        {0.36074100f, 0.78596400f, 0.38781400f},
        {0.36921400f, 0.78888800f, 0.38291400f},
        {0.37777900f, 0.79178100f, 0.37793900f},
        {0.38643300f, 0.79464400f, 0.37288600f},
        {0.39517400f, 0.79747500f, 0.36775700f},
        {0.40400100f, 0.80027500f, 0.36255200f},
        {0.41291300f, 0.80304100f, 0.35726900f},
        {0.42190800f, 0.80577400f, 0.35191000f},
        {0.43098300f, 0.80847300f, 0.34647600f},
        {0.44013700f, 0.81113800f, 0.34096700f},
        {0.44936800f, 0.81376800f, 0.33538400f},
        {0.45867400f, 0.81636300f, 0.32972700f},
        {0.46805300f, 0.81892100f, 0.32399800f},
        {0.47750400f, 0.82144400f, 0.31819500f},
        {0.48702600f, 0.82392900f, 0.31232100f},
        {0.49661500f, 0.82637600f, 0.30637700f},
        {0.50627100f, 0.82878600f, 0.30036200f},
        {0.51599200f, 0.83115800f, 0.29427900f},
        {0.52577600f, 0.83349100f, 0.28812700f},
        {0.53562100f, 0.83578500f, 0.28190800f},
        {0.54552400f, 0.83803900f, 0.27562600f},
        {0.55548400f, 0.84025400f, 0.26928100f},
        {0.56549800f, 0.84243000f, 0.26287700f},
        {0.57556300f, 0.84456600f, 0.25641500f},
        {0.58567800f, 0.84666100f, 0.24989700f},
        {0.59583900f, 0.84871700f, 0.24332900f},
        {0.60604500f, 0.85073300f, 0.23671200f},
        {0.61629300f, 0.85270900f, 0.23005200f},
        {0.62657900f, 0.85464500f, 0.22335300f},
        {0.63690200f, 0.85654200f, 0.21662000f},
        {0.64725700f, 0.85840000f, 0.20986100f},
        {0.65764200f, 0.86021900f, 0.20308200f},
        {0.66805400f, 0.86199900f, 0.19629300f},
        {0.67848900f, 0.86374200f, 0.18950300f},
        {0.68894400f, 0.86544800f, 0.18272500f},
        {0.69941500f, 0.86711700f, 0.17597100f},
        {0.70989800f, 0.86875100f, 0.16925700f},
        {0.72039100f, 0.87035000f, 0.16260300f},
        {0.73088900f, 0.87191600f, 0.15602900f},
        {0.74138800f, 0.87344900f, 0.14956100f},
        {0.75188400f, 0.87495100f, 0.14322800f},
        {0.76237300f, 0.87642400f, 0.13706400f},
        {0.77285200f, 0.87786800f, 0.13110900f},
        {0.78331500f, 0.87928500f, 0.12540500f},
        {0.79376000f, 0.88067800f, 0.12000500f},
        {0.80418200f, 0.88204600f, 0.11496500f},
        {0.81457600f, 0.88339300f, 0.11034700f},
        {0.82494000f, 0.88472000f, 0.10621700f},
        {0.83527000f, 0.88602900f, 0.10264600f},
        {0.84556100f, 0.88732200f, 0.09970200f},
        {0.85581000f, 0.88860100f, 0.09745200f},
        {0.86601300f, 0.88986800f, 0.09595300f},
        {0.87616800f, 0.89112500f, 0.09525000f},
        {0.88627100f, 0.89237400f, 0.09537400f},
        {0.89632000f, 0.89361600f, 0.09633500f},
        {0.90631100f, 0.89485500f, 0.09812500f},
        {0.91624200f, 0.89609100f, 0.10071700f},
        {0.92610600f, 0.89733000f, 0.10407100f},
        {0.93590400f, 0.89857000f, 0.10813100f},
        {0.94563600f, 0.89981500f, 0.11283800f},
        {0.95530000f, 0.90106500f, 0.11812800f},
        {0.96489400f, 0.90232300f, 0.12394100f},
        {0.97441700f, 0.90359000f, 0.13021500f},
        {0.98386800f, 0.90486700f, 0.13689700f},
        {0.99324800f, 0.90615700f, 0.14393600f},
};

typedef struct {
    float x, y, z;
    float color;
} ColoredVector3;

typedef struct {
    ColoredVector3 p[3];
} ColoredTriangle;

ColoredVector3 interpolate(float isolevel, ColoredVector3 p1, ColoredVector3 p2, float v1, float v2) {
    if (fabsf(v1 - v2) < 1e-6) {
        return p1;
    }

    float mu = (isolevel - v1) / (v2 - v1);
    ColoredVector3 p = {
            p1.x + mu * (p2.x - p1.x),
            p1.y + mu * (p2.y - p1.y),
            p1.z + mu * (p2.z - p1.z)
    };
    return p;
}

int march_cube(float* cube, float isolevel, ColoredTriangle* triangles) {
    int cubeindex = 0;
    ColoredVector3 vertlist[12];

    if (cube[0] < isolevel) cubeindex |= 1;
    if (cube[1] < isolevel) cubeindex |= 2;
    if (cube[2] < isolevel) cubeindex |= 4;
    if (cube[3] < isolevel) cubeindex |= 8;
    if (cube[4] < isolevel) cubeindex |= 16;
    if (cube[5] < isolevel) cubeindex |= 32;
    if (cube[6] < isolevel) cubeindex |= 64;
    if (cube[7] < isolevel) cubeindex |= 128;

    if (edgeTable[cubeindex] == 0)
        return 0;

    int i, j, vertexIndex;
    ColoredVector3 vertices[8] = {
            {0, 0, 0}, {1, 0, 0}, {1, 1, 0}, {0, 1, 0},
            {0, 0, 1}, {1, 0, 1}, {1, 1, 1}, {0, 1, 1}
    };

    if (edgeTable[cubeindex] & 1)
        vertlist[0] = interpolate(isolevel, vertices[0], vertices[1], cube[0], cube[1]);
    if (edgeTable[cubeindex] & 2)
        vertlist[1] = interpolate(isolevel, vertices[1], vertices[2], cube[1], cube[2]);
    if (edgeTable[cubeindex] & 4)
        vertlist[2] = interpolate(isolevel, vertices[2], vertices[3], cube[2], cube[3]);
    if (edgeTable[cubeindex] & 8)
        vertlist[3] = interpolate(isolevel, vertices[3], vertices[0], cube[3], cube[0]);
    if (edgeTable[cubeindex] & 16)
        vertlist[4] = interpolate(isolevel, vertices[4], vertices[5], cube[4], cube[5]);
    if (edgeTable[cubeindex] & 32)
        vertlist[5] = interpolate(isolevel, vertices[5], vertices[6], cube[5], cube[6]);
    if (edgeTable[cubeindex] & 64)
        vertlist[6] = interpolate(isolevel, vertices[6], vertices[7], cube[6], cube[7]);
    if (edgeTable[cubeindex] & 128)
        vertlist[7] = interpolate(isolevel, vertices[7], vertices[4], cube[7], cube[4]);
    if (edgeTable[cubeindex] & 256)
        vertlist[8] = interpolate(isolevel, vertices[0], vertices[4], cube[0], cube[4]);
    if (edgeTable[cubeindex] & 512)
        vertlist[9] = interpolate(isolevel, vertices[1], vertices[5], cube[1], cube[5]);
    if (edgeTable[cubeindex] & 1024)
        vertlist[10] = interpolate(isolevel, vertices[2], vertices[6], cube[2], cube[6]);
    if (edgeTable[cubeindex] & 2048)
        vertlist[11] = interpolate(isolevel, vertices[3], vertices[7], cube[3], cube[7]);

    int num_triangles = 0;
    for (i = 0; triTable[cubeindex][i] != -1; i += 3) {
        for (j = 0; j < 3; j++) {
            vertexIndex = triTable[cubeindex][i + j];
            triangles[num_triangles].p[j] = vertlist[vertexIndex];
        }
        num_triangles++;
    }

    return num_triangles;
}

void marching_cubes_chunk(float*** chunk, int chunk_size, float isolevel, ColoredTriangle** triangles, int* num_triangles) {
    int x, y, z;
    float cube[8];
    ColoredTriangle cube_triangles[5];

    *num_triangles = 0;
    *triangles = NULL;

    for (z = 0; z < chunk_size - 1; z++) {
        for (y = 0; y < chunk_size - 1; y++) {
            for (x = 0; x < chunk_size - 1; x++) {
                cube[0] = chunk[z][y][x];
                cube[1] = chunk[z][y][x + 1];
                cube[2] = chunk[z][y + 1][x + 1];
                cube[3] = chunk[z][y + 1][x];
                cube[4] = chunk[z + 1][y][x];
                cube[5] = chunk[z + 1][y][x + 1];
                cube[6] = chunk[z + 1][y + 1][x + 1];
                cube[7] = chunk[z + 1][y + 1][x];
                float avgval = 0.0f;
                for(int i = 0; i < 8; i++)avgval+= cube[i];
                avgval /= 8.0f;
                int coloridx = (int)(avgval*256.f);
                int num_cube_triangles = march_cube(cube, isolevel, cube_triangles);

                if (num_cube_triangles > 0) {
                    *triangles = (ColoredTriangle*)realloc(*triangles, (*num_triangles + num_cube_triangles) * sizeof(ColoredTriangle));
                    for (int i = 0; i < num_cube_triangles; i++) {
                        (*triangles)[*num_triangles + i] = cube_triangles[i];
                        (*triangles)[*num_triangles + i].p[0].x += x;
                        (*triangles)[*num_triangles + i].p[0].y += y;
                        (*triangles)[*num_triangles + i].p[0].z += z;
                        (*triangles)[*num_triangles + i].p[0].color  = avgval;
                        (*triangles)[*num_triangles + i].p[1].x += x;
                        (*triangles)[*num_triangles + i].p[1].y += y;
                        (*triangles)[*num_triangles + i].p[1].z += z;
                        (*triangles)[*num_triangles + i].p[1].color  = avgval;
                        (*triangles)[*num_triangles + i].p[2].x += x;
                        (*triangles)[*num_triangles + i].p[2].y += y;
                        (*triangles)[*num_triangles + i].p[2].z += z;
                        (*triangles)[*num_triangles + i].p[2].color  = avgval;
                    }
                    *num_triangles += num_cube_triangles;
                }
            }
        }
    }
}


void write_colored_ply(const char* filename, ColoredTriangle* triangles, int num_triangles) {
    FILE* file = fopen(filename, "w");
    if (!file) {
        fprintf(stderr, "Failed to open PLY file for writing: %s\n", filename);
        exit(1);
    }

    float color_low = 9999.f;
    float color_high = 0.f;
    for(int i = 0; i < num_triangles; i++){
        for(int j = 0; j < 3; j++){
            if(triangles[i].p[j].color < color_low)color_low =  triangles[i].p[j].color;
            if(triangles[i].p[j].color > color_high)color_high =  triangles[i].p[j].color;
        }
    }

    fprintf(file, "ply\n");
    fprintf(file, "format ascii 1.0\n");
    fprintf(file, "element vertex %d\n", num_triangles * 3);
    fprintf(file, "property float x\n");
    fprintf(file, "property float y\n");
    fprintf(file, "property float z\n");
    fprintf(file, "property uchar red\n");
    fprintf(file, "property uchar green\n");
    fprintf(file, "property uchar blue\n");
    fprintf(file, "element face %d\n", num_triangles);
    fprintf(file, "property list uchar int vertex_index\n");
    fprintf(file, "end_header\n");

    for (int i = 0; i < num_triangles; i++) {
        for (int j = 0; j < 3; j++) {
            int r,g,b;
            r = (int)(viridis_colors[(int)((triangles[i].p[j].color - color_low) / (color_high-color_low)*256.f)][0]*256.f);
            g = (int)(viridis_colors[(int)((triangles[i].p[j].color - color_low) / (color_high-color_low)*256.f)][1]*256.f);
            b = (int)(viridis_colors[(int)((triangles[i].p[j].color - color_low) / (color_high-color_low)*256.f)][2]*256.f);

            fprintf(file, "%f %f %f %d %d %d\n",
                    triangles[i].p[j].x, triangles[i].p[j].y, triangles[i].p[j].z, r, g, b);
        }
    }

    for (int i = 0; i < num_triangles; i++) {
        fprintf(file, "3 %d %d %d\n", i * 3, i * 3 + 1, i * 3 + 2);
    }

    fclose(file);
}

void write_ply(const char* filename, ColoredTriangle* triangles, int num_triangles) {
    FILE* file = fopen(filename, "w");
    if (!file) {
        fprintf(stderr, "Failed to open PLY file for writing: %s\n", filename);
        exit(1);
    }

    fprintf(file, "ply\n");
    fprintf(file, "format ascii 1.0\n");
    fprintf(file, "element vertex %d\n", num_triangles * 3);
    fprintf(file, "property float x\n");
    fprintf(file, "property float y\n");
    fprintf(file, "property float z\n");
    fprintf(file, "element face %d\n", num_triangles);
    fprintf(file, "property list uchar int vertex_index\n");
    fprintf(file, "end_header\n");

    for (int i = 0; i < num_triangles; i++) {
        for (int j = 0; j < 3; j++) {
            fprintf(file, "%f %f %f\n", triangles[i].p[j].x, triangles[i].p[j].y, triangles[i].p[j].z);
        }
    }

    for (int i = 0; i < num_triangles; i++) {
        fprintf(file, "3 %d %d %d\n", i * 3, i * 3 + 1, i * 3 + 2);
    }

    fclose(file);
}

float*** rescale_chunk(unsigned char*** chunk, int chunk_size) {
    int x, y, z;
    float*** rescaled_chunk = (float***)malloc(chunk_size * sizeof(float**));
    for (z = 0; z < chunk_size; z++) {
        rescaled_chunk[z] = (float**)malloc(chunk_size * sizeof(float*));
        for (y = 0; y < chunk_size; y++) {
            rescaled_chunk[z][y] = (float*)malloc(chunk_size * sizeof(float));
            for (x = 0; x < chunk_size; x++) {
                rescaled_chunk[z][y][x] = (float)chunk[z][y][x] / 255.0f;
            }
        }
    }
    return rescaled_chunk;
}

void free_rescaled_chunk(float*** rescaled_chunk, int chunk_size) {
    int z, y;
    for (z = 0; z < chunk_size; z++) {
        for (y = 0; y < chunk_size; y++) {
            free(rescaled_chunk[z][y]);
        }
        free(rescaled_chunk[z]);
    }
    free(rescaled_chunk);
}

int main() {
    const char* directory = "/mnt/c/Users/forrest/dev/Hraun/dl.ash2txt.org/full-scrolls/PHerc1667.volpkg/volumes/20231117161658";
    Volume* volume = create_volume(directory);

    printf("Volume dimensions: %d x %d x %d\n", volume->width, volume->height, volume->depth);

    int chunk_size = 250;
    int chunk_offset_x = 1000;
    int chunk_offset_y = 1000;
    int chunk_offset_z = 500;

    unsigned char*** chunk = volume_chunk(volume, chunk_offset_x, chunk_offset_y, chunk_offset_z, chunk_size, chunk_size, chunk_size);

    float*** rescaled_chunk = rescale_chunk(chunk, chunk_size);

    float isolevel = 0.5f;
    ColoredTriangle* triangles;
    int num_triangles;

    marching_cubes_chunk(rescaled_chunk, chunk_size, isolevel, &triangles, &num_triangles);

    printf("Generated %d triangles\n", num_triangles);

    write_colored_ply("output.ply", triangles, num_triangles);

    free(triangles);
    free_rescaled_chunk(rescaled_chunk, chunk_size);
    free_chunk(chunk, chunk_size, chunk_size);
    free_volume(volume);

    return 0;
}